#!/bin/sh
# Post-install script for Feather mail server

case "$2" in
POST-INSTALL)
    echo "Setting up Feather mail server directories and configuration..."
    
    # Create user and group
    pw groupadd feather >/dev/null 2>&1 || true
    pw useradd feather -g feather -h /usr/local/feather -s /usr/sbin/nologin -c "Feather Mail Server" >/dev/null 2>&1 || true
    
    # Create directories with proper ownership
    install -d -o feather -g feather -m 755 /etc/feather
    install -d -o feather -g feather -m 755 /usr/local/etc/feather
    install -d -o feather -g feather -m 755 /var/log/feather  
    install -d -o feather -g feather -m 755 /var/run/feather

    # Create .env file if it doesn't exist
    if [ ! -f /usr/local/etc/feather/.env ]; then
        umask 077
        cat > /usr/local/etc/feather/.env <<EOF
MIX_ENV=prod
FEATHER_CONFIG_FOLDER=/usr/local/etc/feather/
EOF
        chown feather:feather /usr/local/etc/feather/.env
        chmod 600 /usr/local/etc/feather/.env
        echo "Created configuration file: /usr/local/etc/feather/.env"
    else
        echo "Configuration file already exists: /usr/local/etc/feather/.env"
    fi

    # Create sample server config if it doesn't exist
    if [ ! -f /usr/local/etc/feather/server.exs ]; then
        cat > /usr/local/etc/feather/server.exs <<EOF
server =
  [
    name: "Feather MTA Server",
    address: {0, 0, 0, 0},
    port: 25,
    protocol: :tcp,
    domain: "localhost",
    sessionoptions: [
      
    ]
  ]

EOF
        chown feather:feather /usr/local/etc/feather/server.exs
        chmod 644 /usr/local/etc/feather/server.exs
        echo "Created sample configuration: /usr/local/etc/feather/server.exs"
    fi

  if [ ! -f /usr/local/etc/feather/pipeline.exs ]; then
        cat > /usr/local/etc/feather/pipeline.exs <<EOF
pipeline = []

EOF
        chown feather:feather /usr/local/etc/feather/pipeline.exs
        chmod 644 /usr/local/etc/feather/pipeline.exs
        echo "Created sample configuration: /usr/local/etc/feather/pipeline.exs"
    fi

    # Set rc.conf variables
    echo "Configuring rc.conf variables..."
    sysrc -q feather_dir="/usr/local/feather"
    sysrc -q feather_cmd="/usr/local/feather/bin/feather" 
    sysrc -q feather_args="start"
    sysrc -q feather_user="feather"
    sysrc -q feather_group="feather"
    sysrc -q feather_config_folder="/usr/local/etc/feather/"
    sysrc -q feather_log="/var/log/feather/feather.log"
    sysrc -q feather_pid="/var/run/feather/feather.pid"
    sysrc -q feather_envfile="/usr/local/etc/feather/.env"
    sysrc -q feather_pipeline="/usr/local/etc/feather/pipeline.exs"

    echo "=========================================="
    echo "Feather mail server installation complete"
    echo "=========================================="
    echo "Configuration file: /etc/feather/server.exs"
    echo "Environment file: /usr/local/etc/feather/.env"
    echo "Pipeline file: /usr/local/etc/feather/pipeline.exs"
    echo ""
    echo "To enable at boot: sysrc feather_enable=YES"
    echo "To start now: service feather start"
    ;;
PRE-DEINSTALL)
    echo "Stopping Feather service..."
    service feather stop >/dev/null 2>&1 || true
    ;;
POST-DEINSTALL)
    echo "Feather service has been removed"
    echo "Configuration files in /etc/feather/ have been preserved"
    echo "Log files in /var/log/feather/ have been preserved"
    ;;
*)
    echo "Unexpected argument: $2"
    ;;
esac

exit 0