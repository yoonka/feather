version: 1

metadata:
  name: "feather_msa"

project:
  name: "feather_msa"
  namespace: "feather_msa"

  jails:
    name: "feather_msa"
    artifact:
      to: "/opt/feather"
    config:
      interface: "igb0"
      ip:
        inherit: false
        address: "10.60.5.2"
    dependencies:
      pkg:
        - name: security/openssl
          version: "latest"
    copy:
      - from: ".exlector/configs/msa.exs"
        to: "/etc/feather/msa.exs"
        external: false

    environment:
      FEATHER_DOMAIN: "msa.maxlabmobile.com"
      FEATHER_KEYSTORE_PATH: "/opt/feather/priv/keystore.json"
      FEATHER_SECRET_KEY: "wubbalinnnananabbhsgs"
      FEATHER_TLS_CERT_PATH: "/usr/local/etc/letsencrypt/live/msa.maxlabmobile.com/fullchain.pem"
      FEATHER_TLS_KEY_PATH: "/usr/local/etc/letsencrypt/live/msa.maxlabmobile.com/privkey.pem"
      FEATHER_CONFIG_PATH: "/etc/feather/msa.exs"

    commands:
      - "chmod +x /opt/feather/bin/feather"
      - |
        mkdir -p /opt/feather/priv && \
        openssl req -x509 -newkey rsa:2048 \
          -keyout /opt/feather/priv/key.pem \
          -out /opt/feather/priv/cert.pem \
          -days 365 -nodes \
          -subj '/C=XX/ST=Feather/L=Mail/O=FeatherMail/CN=msa.maxlabmobile.com'
      - ". /etc/profile && /opt/feather/bin/feather daemon"
