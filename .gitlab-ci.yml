stages:
  - build
  - sandbox_deploy
  - release

variables:
  ARTIFACT_NAME: feather
  DOCS_NAME: feather_docs

.prepare_merge: &prepare_merge
  - |
    if [ "$CI_PIPELINE_SOURCE" == "merge_request_event" ]; then
      echo "Preparing merge with target branch ${CI_MERGE_REQUEST_TARGET_BRANCH_NAME}"
      git config --global user.email "ci@example.com"
      git config --global user.name "ci-bot"
      git fetch origin $CI_MERGE_REQUEST_TARGET_BRANCH_NAME
      if ! git merge --no-commit --no-ff origin/$CI_MERGE_REQUEST_TARGET_BRANCH_NAME; then
        echo "Merge conflict detected! Exiting pipeline as merge result would fail."
        exit 1
      fi
      echo "Merge successful, continuing pipeline."
    else
      echo "Not a merge request event. Skipping prepare_merge."
    fi

test_build_freebsd:
  stage: build
  tags: [freebsd]
  before_script:
    - *prepare_merge
  script:
    - sudo -E exlector artifactory -f .exlector/artifactory.yaml --compress --build_path dist --name $ARTIFACT_NAME
    - tar -xzf $ARTIFACT_NAME.tar.gz
    # Optional: show what we built
    - echo "== Built packages ==" && find . -name '*.pkg' -maxdepth 3 -print
  artifacts:
    name: "feather_freebsd"
    paths:
      - '**/*.pkg'
    expire_in: 1 week
  rules:
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /(master|develop)/
    - if: $CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_TAG

generate_docs:
  stage: build
  tags: [freebsd]
  needs: [test_build_freebsd]
  dependencies: [test_build_freebsd]
  script:
    - sudo -E exlector artifactory -f .exlector/docs-generate.yaml --compress --build_path doc/ --name $DOCS_NAME
  artifacts:
    paths:
      - $DOCS_NAME.tar.gz
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop"
    - if: $CI_COMMIT_TAG

push_docs_to_sandbox:
  stage: sandbox_deploy
  needs: [generate_docs]
  dependencies: [generate_docs]
  tags: [freebsd]
  script:
    - echo "Deploying docs to sandbox..."
    - sudo exlector deploy-jail -f .exlector/deploy-docs.yaml --path $DOCS_NAME.tar.gz
  rules:
    - if: $CI_COMMIT_BRANCH == "master" || $CI_COMMIT_BRANCH == "develop"
      when: manual

upload_package:
  stage: release
  # Using a Debian-ish image so apt-get works
  image: curlimages/curl:latest
  needs:
    - test_build_freebsd
    - generate_docs
  dependencies:
    - test_build_freebsd
    - generate_docs
  script:
    - echo "Finding built .pkg artifact..."
    - PKG_FILE="$(find . -type f -name '*.pkg' | head -n1)"
    - test -n "$PKG_FILE" || (echo "No .pkg found" && exit 1)
    - cp "$PKG_FILE" feather_freebsd.pkg
    - echo "Uploading feather_freebsd.pkg and docs tarball..."
    - |
      curl --fail --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
        --upload-file feather_freebsd.pkg \
        "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/feather/${CI_COMMIT_TAG}/feather_freebsd.pkg"
    - |
      if [ -f "$DOCS_NAME.tar.gz" ]; then
        curl --fail --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
          --upload-file "$DOCS_NAME.tar.gz" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/feather/${CI_COMMIT_TAG}/$DOCS_NAME.tar.gz"
      else
        echo "Docs tarball not present; skipping docs upload."
      fi
  rules:
    - if: $CI_COMMIT_TAG

create_release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs: [upload_package]
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - |
      release-cli create \
        --name "Feather $CI_COMMIT_TAG" \
        --tag-name "$CI_COMMIT_TAG" \
        --description "Automated release for Feather $CI_COMMIT_TAG" \
        --assets-link "{\"name\":\"Feather FreeBSD Binary\",\"url\":\"${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/feather/${CI_COMMIT_TAG}/feather_freebsd.pkg\"}" \
        --assets-link "{\"name\":\"Feather Docs\",\"url\":\"${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/feather/${CI_COMMIT_TAG}/$DOCS_NAME.tar.gz\"}"
